# 系统初始化功能

## 概述

系统初始化功能在应用启动时自动检测数据库状态，如果发现租户和部门为空，会自动创建默认的系统租户和总公司部门。

## 功能特性

- **自动检测**: 应用启动时自动检测数据库中的租户和部门数量
- **智能创建**: 仅在数据库为空时创建默认数据
- **配置化**: 支持通过配置文件自定义初始化参数
- **幂等性**: 多次启动不会重复创建数据
- **错误处理**: 完善的错误处理和日志记录

## 配置说明

在 `configs/config.yml` 中可以配置初始化参数：

```yaml
system:
  init:
    auto_init: true              # 是否启用自动初始化
    tenant_name: "系统"          # 系统租户名称
    tenant_owner_id: 0          # 系统租户拥有者ID
    root_dept_name: "总公司"     # 根部门名称
```

## 初始化流程

1. **数据库迁移**: 首先执行数据库模式迁移
2. **状态检查**: 检查租户和部门数量
3. **租户创建**: 如果租户为空，创建名为"系统"的租户
4. **部门创建**: 如果部门为空，创建名为"总公司"的根部门
5. **路径设置**: 为根部门设置正确的 ltree 路径

## 创建的数据结构

### 系统租户
- **名称**: 系统
- **状态**: ACTIVE
- **拥有者ID**: 0
- **属性**: 包含描述和类型信息

### 总公司部门
- **名称**: 总公司
- **租户ID**: 关联到系统租户
- **父级ID**: 0 (根部门)
- **路径**: 使用 ltree 格式存储层级关系
- **属性**: 包含描述和层级信息

## 使用示例

### 基本使用
```go
// 使用默认配置初始化
initService := service.NewInitService(client)
err := initService.InitializeSystem(ctx)
```

### 自定义配置
```go
// 使用自定义配置初始化
config := &service.InitConfig{
    SystemTenantName:    "默认租户",
    SystemTenantOwnerID: 1,
    RootDeptName:        "总部",
    AutoInit:            true,
}

initService := service.NewInitService(client)
err := initService.InitializeSystemWithConfig(ctx, config)
```

### 禁用自动初始化
```yaml
system:
  init:
    auto_init: false
```

## 日志输出

初始化过程中会输出详细的日志信息：

```
[INFO] 开始初始化系统数据...
[INFO] 已创建系统租户
[INFO] 系统租户已就绪，ID: 1234567890
[INFO] 已创建总公司部门
[INFO] 总公司部门已就绪
[INFO] 系统初始化完成
```

## 错误处理

如果初始化过程中出现错误，应用会记录错误并退出：

```
[FATAL] 系统初始化失败: 创建系统租户失败: 数据库连接错误
```

## 注意事项

1. **数据库连接**: 确保数据库连接正常
2. **权限要求**: 确保应用有创建表和数据的权限
3. **并发安全**: 初始化过程是线程安全的
4. **数据完整性**: 创建的数据符合业务规则和约束

## 故障排除

### 常见问题

1. **初始化失败**
   - 检查数据库连接
   - 检查数据库权限
   - 查看详细错误日志

2. **重复初始化**
   - 系统具有幂等性，不会重复创建
   - 如果数据已存在，会跳过创建

3. **配置不生效**
   - 检查配置文件路径
   - 确认配置格式正确
   - 重启应用使配置生效

## 扩展功能

可以通过修改 `InitService` 来扩展初始化功能：

- 创建默认用户
- 初始化权限数据
- 设置默认配置
- 导入基础数据
